<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Snort Intrusion Detection, Rule Writing, and PCAP Analysis | Henry Post</title><meta name=generator content="Hugo Eureka 0.7.1-dev"><link rel=stylesheet href=/css/eureka.min.css><script defer src=/js/eureka.min.js></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script><link rel=icon type=image/png sizes=32x32 href=/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_32x32_fill_box_center_2.png><link rel=apple-touch-icon sizes=180x180 href=/images/icon_hu64421c6c7700f606f0ad45d807017b09_5843_180x180_fill_box_center_2.png><meta name=description content="The course The course this post is based off of is Snort Intrusion Detection, Rule Writing, and PCAP Analysis by Jesse Kurrus.
Tools  OSes  Kali Windows 7 Security Onion   Snort IDS Squirt  Snort Resources  Snort Users Manual Snort Rule Writing Manual Infosec Institute Snort Rule Writing Overview Emerging Threats Snort Rules Snort Community and Blog Network Security Onion Google Group  Lab 1: Security Onion VM Setup Some specific network settings should be used to allow capturing of packets."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"Snort Intrusion Detection, Rule Writing, and PCAP Analysis","item":"/posts/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/"},"headline":"Snort Intrusion Detection, Rule Writing, and PCAP Analysis | Henry Post","datePublished":"2020-05-30T00:00:00+00:00","dateModified":"2020-05-30T00:00:00+00:00","wordCount":1267,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/icon.png"}},"description":"The course The course this post is based off of is Snort Intrusion Detection, Rule Writing, and PCAP Analysis by Jesse Kurrus.\nTools  OSes  Kali Windows 7 Security Onion   Snort IDS Squirt  Snort Resources  Snort Users Manual Snort Rule Writing Manual Infosec Institute Snort Rule Writing Overview Emerging Threats Snort Rules Snort Community and Blog Network Security Onion Google Group  Lab 1: Security Onion VM Setup Some specific network settings should be used to allow capturing of packets."}</script><meta property="og:title" content="Snort Intrusion Detection, Rule Writing, and PCAP Analysis | Henry Post"><meta property="og:type" content="article"><meta property="og:image" content="/images/icon.png"><meta property="og:url" content="/posts/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/"><meta property="og:description" content="The course The course this post is based off of is Snort Intrusion Detection, Rule Writing, and PCAP Analysis by Jesse Kurrus.
Tools  OSes  Kali Windows 7 Security Onion   Snort IDS Squirt  Snort Resources  Snort Users Manual Snort Rule Writing Manual Infosec Institute Snort Rule Writing Overview Emerging Threats Snort Rules Snort Community and Blog Network Security Onion Google Group  Lab 1: Security Onion VM Setup Some specific network settings should be used to allow capturing of packets."><meta property="og:locale" content="en"><meta property="og:site_name" content="Henry Post"><meta property="article:published_time" content="2020-05-30T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-30T00:00:00+00:00"><meta property="article:section" content="posts"><body class="flex flex-col min-h-screen"><header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="mr-6 text-primary-text text-xl font-bold">Henry Post</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/about-site/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About Site</a>
<a href=/contact/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Contact</a>
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a>
<a href=/interests/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Interests</a>
<a href=/projects/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Projects</a>
<a href=/resume/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Resume</a>
<a href=/skills/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Skills</a>
<a href=/certifications/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Certifications</a>
<a href=/why-me/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Why me?</a>
<a href=/docs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Docs</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12"><div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8"><h1 class="font-bold text-3xl text-primary-text">Snort Intrusion Detection, Rule Writing, and PCAP Analysis</h1><div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text"><div class="mr-6 my-2"><i class="fas fa-calendar mr-1"></i>
<span>2020-05-30</span></div><div class="mr-6 my-2"><i class="fas fa-clock mr-1"></i>
<span>6 min read</span></div><div class="mr-6 my-2"><i class="fas fa-folder mr-1"></i>
<a href=/categories/network/ class=hover:text-eureka>network</a>
<span>,</span>
<a href=/categories/security/ class=hover:text-eureka>security</a></div></div><div class=content><h2 id=the-course>The course</h2><p>The course this post is based off of is Snort Intrusion Detection, Rule Writing, and PCAP Analysis by Jesse Kurrus.</p><h2 id=tools>Tools</h2><ul><li>OSes<ul><li>Kali</li><li>Windows 7</li><li><a href=https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md>Security Onion</a></li></ul></li><li>Snort IDS</li><li>Squirt</li></ul><h3 id=snort-resources>Snort Resources</h3><ul><li><a href=http://manual-snort-org.s3-website-us-east-1.amazonaws.com/>Snort Users Manual</a></li><li><a href=http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node27.html>Snort Rule Writing Manual</a></li><li><a href=http://resources.infosecinstitute.com/snort-rules-workshop-part-one/#gref>Infosec Institute Snort Rule Writing Overview</a></li><li><a href=https://rules.emergingthreats.net/open/snort-2.9.0/rules/>Emerging Threats Snort Rules</a></li><li><a href=https://snort.org/community>Snort Community and Blog Network</a></li><li><a href=https://groups.google.com/forum/#!forum/security-onion>Security Onion Google Group</a></li></ul><h2 id=lab-1-security-onion-vm-setup>Lab 1: Security Onion VM Setup</h2><p>Some specific network settings should be used to allow capturing of packets.</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/vm-network-interfaces.PNG alt>
<img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/sec-onion-vm-network-settings-1.PNG alt>
<img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/sec-onion-vm-network-settings-2.PNG alt></p><h3 id=installation-notes>Installation notes</h3><ol><li><p>Don&rsquo;t check the box to download updates</p></li><li><p>Don&rsquo;t download extra drivers/WiFi drivers</p></li><li><p>Use defaults for partitioning options</p></li><li><p>Take a snapshot when you log in</p></li><li><p>Install Guest additions, then <code>sudo reboot now</code>.</p></li><li><p>Run &lsquo;Setup&rsquo; on the desktop.</p></li><li><p>Choose &lsquo;Yes&rsquo; for &lsquo;configure /etc/network/interfaces&rsquo;.</p></li><li><p>Choose <code>enp0s3</code> for the management interface, because this is the NAT-ed interface.</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/management-interface-selection.png alt></p><p><code>enp0s8</code> is the host-only interface, which will only be used for sniffing.</p></li><li><p>Choose DHCP addressing for <code>enp0s3</code>.</p></li><li><p>Choose &lsquo;Yes&rsquo; for &lsquo;Configure sniffing interfaces&rsquo;.</p></li><li><p>Your changes should look like this:</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/changes-to-network-setup.png alt></p><p>Click &lsquo;Yes&rsquo; and reboot.</p></li><li><p>After rebooting, run setup again. Skip network config.</p></li><li><p>Select &lsquo;Evaluation Mode&rsquo;.</p></li><li><p><code>enp0s8</code> should be monitored as it is the host-only interface for sniffing.</p></li><li><p>Make a new user, wait for the install to finish, and then some dialog boxes will show up.
Feel free to read them, they have some useful commands.</p></li></ol><p>Here is the text from the dialog boxes:</p><pre><code>Security Onion Setup is now complete!

Setup log can be found here:
/var/log/nsm/sosetup.log

You may view IDS alerts using Sguil, Squert, or Kibana (if enabled).

Zeek logs can be found in Kibana (if enabled) and the following location:
/nsm/zeek/

You can check the status of your running services with the sostat utilites:

'sudo sostat' will give you DETAILED information about your service status.

'sudo sostat-quick' will give you a guided tour of the sostat output.

'sudo sostat-redacted' will give you REDACTED information to share with our mailing list if you have questions.

Rules downloaded by Pulledpork are stored in:
/etc/nsm/rules/downloaded.rules

Local rules can be added to:
/etc/nsm/rules/local.rules

You can have PulledPork modify the downloaded rules by modifying the files in:
/etc/nsm/pulledpork/

Rules will be updated every morning.

You can manually update them by running:
sudo rule-update

Sensors can be tuned by modifying the files in:
/etc/nsm/NAME-OF-SENSOR/

Please note that the local ufw firewall has been locked down.

It only allows connections to port 22.

If you need to connect over any other port, then run:
sudo so-allow

If you have any questions or problems, please visit:
https://securityonion.net

There you'll find the following links:
FAQ
Documentation
Mailing Lists
IRC channel
and more!

If you're interested in training, professional services, or hardware appliances, please see:

https://securityonionsolutions.com
</code></pre><h3 id=post-setup>Post-setup</h3><ul><li>Update Security Onion with <code>sudo soup</code>. Then reboot.</li><li>NOTE: Remember that <code>sudo sostat</code> can be used for troubleshooting most things in SO (Security Onion).</li><li><code>sudo nsm_sensor_ps-restart</code> will restart all SO services.</li><li>Common issue is that Squert doesn&rsquo;t show Snort alerts.<ul><li>Might be bad custom rules, Sguil service failing, or sniffing interface not processing packets.</li></ul></li></ul><h3 id=testing-squert-showing-snort-alerts>Testing Squert showing Snort alerts</h3><ul><li>Replay a malicious packet using <code>tcp_replay</code>:<ul><li>Run <code>locate zeus</code> to find the pcap.</li><li>Run <code>sudo tcpreplay -l 20 -i enp0s8 -t /opt/samples/zeus-sample-1.pcap</code> to replay the pcap 20 times.</li><li>Ignore the error messages.</li><li>Double click &lsquo;Squert&rsquo; on the desktop and login.
You should see alerts indicating ZEUS Trojan activity.</li><li>If you don&rsquo;t see these alerts, this is bad and you must troubleshoot.</li></ul></li></ul><h2 id=lab-2-boleto-malware-snort-rule-writing-and-pcap-analysis>Lab 2: Boleto Malware Snort Rule Writing and PCAP analysis</h2><h3 id=setup>Setup</h3><ul><li>Go to <a href=http://malware-traffic-analysis.net/>http://malware-traffic-analysis.net/</a> and download the pcap file from the &lsquo;YOUR HOLIDAY PRESENT&rsquo; exercise.</li></ul><p>Optional UI options:</p><ul><li><p>edit > preferences > appearance > columns</p></li><li><p>uncheck &lsquo;no&rsquo;, &lsquo;protocol&rsquo;, &lsquo;length&rsquo; (if you want, I left &lsquo;no&rsquo; and &lsquo;protocol&rsquo;.)</p></li><li><p>add 2 new columns:</p><ul><li>&lsquo;Src Port&rsquo; - Src Port (unresolved)</li><li>&lsquo;Dst Port&rsquo; - Dst Port (unresolved)</li></ul></li><li><p>Filter to only view <code>http.request</code> to only see HTTP requests:</p></li></ul><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-httprequest.png alt></p><ul><li>Then, click on any host in the request, and <code>right click > apply as column</code>.</li></ul><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-httphost-column.png alt></p><ul><li><code>view > time display format > first option</code></li><li><code>view > time display format > seconds: 0</code></li></ul><h3 id=analysis>Analysis</h3><p>This network traffic is from a user called &lsquo;Matthew Frogman&rsquo; who clicked on a malicious email and got infected.</p><p>The domain <code>wme0hsxg [dot] e6to8jdmiysycbmeepm29nfprvigdwev [dot] top</code>, in packet 117, is the root cause of the infection.</p><p>They clicked on this link in an email and as a result, downloaded a VBE file that kicked off the infection.</p><p>Packet number 199 shows the request that asks for the VBE file:</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-vbe.png alt></p><p>VBE files are like VBS scripts, but encoded.</p><p>All of the .txt, .tiff, .dll, .exe files are post-infection files (i.e. packet 379):</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-post-infect-txt.png alt></p><p>Some other indicators of post-infection are packets like packet 484 or 2467.</p><h3 id=making-snort-rules-based-off-of-these-packets>Making snort rules based off of these packets</h3><ul><li>Open a terminal</li><li><code>sudo vi /etc/nsm/rules/local.rules</code></li></ul><p>{% highlight bash linenos %}</p><p>alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:&ldquo;Probable successful phishing attack."; flow:established,to_server; content:&ldquo;GET&rdquo;; http_method; content:"/1dkfJu.php?"; http_uri; classtype: trojan-activity; sid: 10000001; rev:1;)
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:&ldquo;Probable post-infection - Boleto-themed malicious spam. First indicator."; flow:established,to_server; content:&ldquo;GET&rdquo;; http_method; content:"/bibi/"; http_uri; pcre:"/(.txt|.tiff|.zip|.dll|.exe)/U&rdquo;; classtype:trojan-activity; sid:10000002; rev:1;)
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:&ldquo;Probable post-infection - Boleto-themed malicious spam. Second indicator."; flow:established,to_server; content:&ldquo;GET&rdquo;; http_method; content:"/bsb/infects/index.php?"; http_uri; classtype:trojan-activity; sid:10000003; rev:1;)
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:&ldquo;Probable post-infection - Boleto-themed malicious spam. Third indicator."; flow:established,to_server; content:&ldquo;GET&rdquo;; http_method; content:"/bsb/debugnosso/index.php?"; http_uri; classtype:trojan-activity; sid:10000004; rev:1;)
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:&ldquo;Probable post-infection - Boleto-themed malicious spam. Fourth indicator."; flow:established,to_server; content:&ldquo;POST&rdquo;; http_method; content:"/mestre/admin/x.php&rdquo;; http_uri; classtype:trojan-activity; sid:10000005; rev:1;)</p><p>{% endhighlight %}</p><h4 id=line-1>Line 1</h4><p>Alert on TCP traffic coming from our internal net to an external network that is using HTTP ports.</p><p>The content match for the content after the &lsquo;HTTP GET&rsquo; filter comes from TCP stream 1, which contains <code>/1dkfJu.php?</code>,
which is an indicator of Boleto malware. This is static, as opposed to all parameters that come after the question
mark.</p><p>Note that this will ONLY match HTTP request URI content containing <code>/1dkfJu.php?</code>, not HTTP request body content,
because of the rules.</p><h4 id=line-2>Line 2</h4><p>Alert on TCP traffic coming from our internal net to an external network that is using HTTP ports.</p><p>The content match for the content of the HTTP URI comes from packets like 1393, which download payloads from
the <code>/bibi/</code> directory.</p><p>This expression, <code>pcre:"/(\.txt|\.tiff|\.zip|\.dll|\.exe)/U";</code>, is a Perl-style regex that matches a few file extensions.</p><h4 id=line-3>Line 3</h4><p>Similar to the first two, but a different URI indicator.</p><p>Packet 484 has a URI beginning with <code>/bsb/infects/index.php?</code>.</p><p>Follow the TCP stream of that packet, and you&rsquo;ll see what we use for line 4&rsquo;s rule.</p><h4 id=line-4>Line 4</h4><p>Similar to the first three, but again, a different URI indicator.</p><p>Packet 487 has the URI we will use, which is <code>/bsb/debugnosso/index.php?</code>:</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-debugnosso.png alt></p><h4 id=line-5>Line 5</h4><p>Similar to the first four, but matches HTTP POST instead of HTTP GET.</p><p>Packet 2467 has the URI we will use in this filter, <code>/mestre/admin/x.php</code>.</p><h3 id=testing-the-rules>Testing the rules</h3><p>After copying the rules into <code>/etc/nsm/rules/local.rules</code>, run</p><pre><code>sudo rule-update
</code></pre><p>to use the new rules, and then</p><pre><code>sudo tcpreplay -t -i enp0s8 2016-12-17-traffic-analysis-exercise.pcap
</code></pre><p>To replay the captured packets over our sniffing interface.</p><p>You can add <code>-l 5</code> to run it 5 times.</p><p>Remember that <code>enp0s8</code> is our sniffing interface. Might be different for you depending on what VM
solution you use.</p><p>If we wrote the rules correctly, we should see it show up in Squert!</p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-squert.png alt></p><p><img src=/static/images/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/lab2-squert2.png alt></p><p>That&rsquo;s it!</p><h2 id=lab-3-vetting-snort-rule-quality-with-dumbpig>Lab 3: Vetting Snort Rule Quality with Dumbpig</h2><p>Dumbpig is a great tool to validate snort rules.</p><p><a href=https://github.com/leonward/dumbpig/>https://github.com/leonward/dumbpig/</a></p><p>Clone the repo:</p><pre><code>git clone https://github.com/leonward/dumbpig/
</code></pre><p>Install Parse::Snort in perl:</p><pre><code>sudo cpan Parse::Snort
</code></pre><p>Test the Snort rules we wrote:</p><pre><code>cd dumbpig
sudo perl dumbpig.pl -r /etc/nsm/rules/local.rules
</code></pre><p>You can also <a href=/static/files/2020-05-30-snort-intrusion-detection-rule-writing-and-pcap-analysis/bad-rules.rules>download some bad rules here</a>. Feel free to test them.</p><h2 id=lab-4-todo>Lab 4: TODO</h2></div><div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t"><div><span class="block font-bold">Previous</span>
<a href=/posts/2020-06-15-csslp-notes/ class=block>Certified Secure Software Lifecycle Professional (CSSLP) Notes</a></div><div class="md:text-right mt-4 md:mt-0"><span class="block font-bold">Next</span>
<a href=/posts/2020-04-27-analyzing-document-based-malware-and-reverse-engineering-it/ class=block>Analyzing document-based malware and reverse engineering it</a></div></div></div><div class=col-span-2><div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg"><span class="text-lg font-semibold">On This Page</span></div><div class="sticky-toc hidden lg:block px-6 pb-6"><nav id=TableOfContents><ul><li><a href=#the-course>The course</a></li><li><a href=#tools>Tools</a><ul><li><a href=#snort-resources>Snort Resources</a></li></ul></li><li><a href=#lab-1-security-onion-vm-setup>Lab 1: Security Onion VM Setup</a><ul><li><a href=#installation-notes>Installation notes</a></li><li><a href=#post-setup>Post-setup</a></li><li><a href=#testing-squert-showing-snort-alerts>Testing Squert showing Snort alerts</a></li></ul></li><li><a href=#lab-2-boleto-malware-snort-rule-writing-and-pcap-analysis>Lab 2: Boleto Malware Snort Rule Writing and PCAP analysis</a><ul><li><a href=#setup>Setup</a></li><li><a href=#analysis>Analysis</a></li><li><a href=#making-snort-rules-based-off-of-these-packets>Making snort rules based off of these packets</a><ul><li><a href=#line-1>Line 1</a></li><li><a href=#line-2>Line 2</a></li><li><a href=#line-3>Line 3</a></li><li><a href=#line-4>Line 4</a></li><li><a href=#line-5>Line 5</a></li></ul></li><li><a href=#testing-the-rules>Testing the rules</a></li></ul></li><li><a href=#lab-3-vetting-snort-rule-quality-with-dumbpig>Lab 3: Vetting Snort Rule Quality with Dumbpig</a></li><li><a href=#lab-4-todo>Lab 4: TODO</a></li></ul></nav></div><script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script></div></div><script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://www.wangchucheng.com/>C. Wang</a> and <a href=https://www.ruiqima.com/>R. Ma</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>